name: Monthly Insurance Crawl

on:
  # ë§¤ë‹¬ 1ì¼ ì˜¤ì „ 3ì‹œ (í•œêµ­ ì‹œê°„ 12ì‹œ)
  schedule:
    - cron: '0 3 1 * *'

  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd crawler
          npm install

      - name: Install Playwright browsers
        run: |
          cd crawler
          npx playwright install chromium

      - name: Run crawler
        run: |
          cd crawler
          node crawl-all-urls.js

      - name: Check results
        run: |
          cd crawler/data
          echo "ìˆ˜ì§‘ëœ íŒŒì¼:"
          ls -lh products_final_*.json
          echo ""
          echo "ìˆ˜ì§‘ ê°œìˆ˜:"
          cat products_final_*.json | grep -c "productName" || echo "0"

      - name: Upload to Supabase (optional)
        if: false  # ë‚˜ì¤‘ì— í™œì„±í™”
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          node upload-pdfs.js

      - name: Commit results
        run: |
          git config user.name "Insurance Crawler Bot"
          git config user.email "bot@insu-brain.com"
          git add crawler/data/
          git diff --staged --quiet || git commit -m "Update: $(date +'%Y-%m-%d') crawl results [skip ci]"
          git push

      - name: Create summary
        run: |
          cd crawler/data
          LATEST_FILE=$(ls -t products_final_*.json | head -1)
          PRODUCT_COUNT=$(cat $LATEST_FILE | grep -c "productName")
          echo "## í¬ë¡¤ë§ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“… ì‹¤í–‰ ì¼ì‹œ: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š ìˆ˜ì§‘ ê°œìˆ˜: $PRODUCT_COUNT ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ íŒŒì¼: $LATEST_FILE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ì¶œì²˜ë³„ í†µê³„" >> $GITHUB_STEP_SUMMARY
          grep "source" $LATEST_FILE | sort | uniq -c | head -15 >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ í¬ë¡¤ë§ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
